From cfb6bc3268d5871321cbf41e7048338c7c7661a1 Mon Sep 17 00:00:00 2001
From: Jacques Gagnon <darthcloud@gmail.com>
Date: Sun, 10 Jan 2021 19:04:55 -0500
Subject: [PATCH 2/2] Hijack level 2 interrupt for core1

---
 components/freertos/port/xtensa/xtensa_vectors.S | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/components/freertos/port/xtensa/xtensa_vectors.S b/components/freertos/port/xtensa/xtensa_vectors.S
index 4fd27e45c..6111ca9ac 100644
--- a/components/freertos/port/xtensa/xtensa_vectors.S
+++ b/components/freertos/port/xtensa/xtensa_vectors.S
@@ -1161,11 +1161,24 @@ _xt_medint2:
     s32i    a0, sp, XT_STK_PS
     rsr     a0, EPC_2                       /* save interruptee's PC */
     s32i    a0, sp, XT_STK_PC
+    s32i    a12, sp, XT_STK_A12             /* _xt_context_save requires a12,a13 */
+    s32i    a13, sp, XT_STK_A13
+    call0   _xt_context_save                /* Save xtensa context */
     rsr     a0, EXCSAVE_2                   /* save interruptee's a0 */
     s32i    a0, sp, XT_STK_A0
     movi    a0, _xt_medint2_exit            /* save exit point for dispatch */
     s32i    a0, sp, XT_STK_EXIT
 
+    movi    a0, PS_INTLEVEL(2) | PS_UM | PS_WOE
+    wsr     a0, PS
+    rsync
+
+    mov     a6,sp
+    call4   npiso_isr
+
+    call0   _xt_medint2_exit
+
+#if 0
     /* EXCSAVE_2 should now be free to use. Use it to keep a copy of the
     current stack pointer that points to the exception frame (XT_STK_FRAME).*/
     #ifdef XT_DEBUG_BACKTRACE
@@ -1195,6 +1208,7 @@ _xt_medint2:
 
     /* Done handling interrupts, transfer control to OS */
     call0   XT_RTOS_INT_EXIT                /* does not return directly here */
+#endif
 
     /*
     Exit point for dispatch. Saved in interrupt stack frame at XT_STK_EXIT
@@ -1205,6 +1219,7 @@ _xt_medint2:
     .align      4
 _xt_medint2_exit:
     /* Restore only level-specific regs (the rest were already restored) */
+    call0   _xt_context_restore
     l32i    a0, sp, XT_STK_PS               /* retrieve interruptee's PS */
     wsr     a0, EPS_2
     l32i    a0, sp, XT_STK_PC               /* retrieve interruptee's PC */
-- 
2.17.1

